<!-- templates/approvisionnements.html -->
{% extends "base.html" %}

{% block title %}Approvisionnements{% endblock %}

{% block content %}
    <h1>Enregistrer un approvisionnement</h1>

    <form method="POST">
        <div class="form-group" style="position: relative;">
            <label>Nom du produit</label>
            <input 
                type="text" 
                name="nom" 
                id="nom-produit-input"
                required 
                autocomplete="off"
                style="width: 300px; position: relative; z-index: 1;"
            >
            <!-- Suggestions pour le nom du produit -->
            <div 
                id="suggestions-produit" 
                style="
                    position: absolute; 
                    background: white; 
                    border: 1px solid #ccc; 
                    border-radius: 4px;
                    max-height: 200px; 
                    overflow-y: auto; 
                    z-index: 1000; 
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    display: none;
                    left: 0;
                    top: 100%; 
                    width: 300px;
                    margin-top: 2px;
                ">
            </div>
        </div>
        <div class="form-group">
            <label>Quantité</label>
            <input type="number" name="quantite" required>
        </div>
        <div class="form-group">
            <label>Prix d'achat</label>
            <input type="number" step="0.01" name="prix_achat" id="prix-achat-input" required>
        </div>
        <div class="form-group">
            <label>Prix de vente</label>
            <input type="number" step="0.01" name="prix_vente" id="prix-vente-input" required>
        </div>
        <div class="form-group">
            <label>Fournisseur</label>
            <select name="id_fournisseur">
                <option value="">Aucun</option>
                {% for f in fournisseurs %}
                    <option value="{{ f.id }}">{{ f.nom }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label>Catégorie</label>
            <input type="text" name="categorie">
        </div>
        <button type="submit">Enregistrer</button>
    </form>

    <!-- Script d'autocomplétion pour les produits -->
    <script>
        const inputProduit = document.getElementById('nom-produit-input');
        const suggestionsProduit = document.getElementById('suggestions-produit');
        const prixAchatInput = document.getElementById('prix-achat-input');
        const prixVenteInput = document.getElementById('prix-vente-input');

        // Affiche/masque les suggestions
        function showSuggestionsProduit(items) {
            suggestionsProduit.innerHTML = '';
            if (items.length === 0) {
                suggestionsProduit.style.display = 'none';
                return;
            }

            items.forEach(item => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <div style="font-weight: bold;">${item.nom}</div>
                    <div style="font-size: 12px; color: #666;">
                        Achat: ${item.prix_achat}F - Vente: ${item.prix_vente}F - Stock: ${item.quantite}
                    </div>
                `;
                div.style.padding = '8px 12px';
                div.style.cursor = 'pointer';
                div.style.borderBottom = '1px solid #eee';
                div.style.fontSize = '14px';
                div.style.backgroundColor = 'white';
                
                div.onmouseenter = () => div.style.backgroundColor = '#f8f9fa';
                div.onmouseleave = () => div.style.backgroundColor = 'white';
                
                div.onclick = () => {
                    // Remplir le nom du produit
                    inputProduit.value = item.nom;
                    
                    // Pré-remplir les prix avec les valeurs existantes
                    prixAchatInput.value = item.prix_achat;
                    prixVenteInput.value = item.prix_vente;
                    
                    suggestionsProduit.style.display = 'none';
                    
                    // Mettre le focus sur le champ quantité
                    document.querySelector('input[name="quantite"]').focus();
                };
                
                suggestionsProduit.appendChild(div);
            });
            suggestionsProduit.style.display = 'block';
        }

        // Recherche avec délai pour éviter les appels excessifs
        let timeoutIdProduit;
        inputProduit.addEventListener('input', function() {
            const query = this.value.trim();
            
            if (query.length < 2) {
                suggestionsProduit.style.display = 'none';
                // Vider les champs prix si on efface le nom
                if (query.length === 0) {
                    prixAchatInput.value = '';
                    prixVenteInput.value = '';
                }
                return;
            }

            // Délai de 300ms pour éviter trop de requêtes
            clearTimeout(timeoutIdProduit);
            timeoutIdProduit = setTimeout(() => {
                fetch(`/recherche_produit_complet?q=${encodeURIComponent(query)}`)
                    .then(response => {
                        console.log("Réponse de /recherche_produit_complet:", response.status);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        console.log("Données reçues:", data);
                        showSuggestionsProduit(data);
                    })
                    .catch(err => {
                        console.error("Erreur dans /recherche_produit_complet:", err);
                        suggestionsProduit.style.display = 'none';
                    });
            }, 300);
        });

        // Masquer les suggestions si on clique ailleurs
        document.addEventListener('click', function(e) {
            if (!inputProduit.contains(e.target) && !suggestionsProduit.contains(e.target)) {
                suggestionsProduit.style.display = 'none';
            }
        });

        // Gestion des touches fléchées
        let selectedIndexProduit = -1;
        inputProduit.addEventListener('keydown', function(e) {
            const suggestions = suggestionsProduit.querySelectorAll('div[style*="cursor: pointer"]');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndexProduit = Math.min(selectedIndexProduit + 1, suggestions.length - 1);
                updateSelectionProduit(suggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndexProduit = Math.max(selectedIndexProduit - 1, -1);
                updateSelectionProduit(suggestions);
            } else if (e.key === 'Enter' && selectedIndexProduit >= 0) {
                e.preventDefault();
                suggestions[selectedIndexProduit].click();
            } else if (e.key === 'Escape') {
                suggestionsProduit.style.display = 'none';
                selectedIndexProduit = -1;
            }
        });

        function updateSelectionProduit(suggestions) {
            suggestions.forEach((div, index) => {
                if (index === selectedIndexProduit) {
                    div.style.backgroundColor = '#007BFF';
                    div.style.color = 'white';
                } else {
                    div.style.backgroundColor = 'white';
                    div.style.color = 'black';
                }
            });
        }
    </script>
{% endblock %}